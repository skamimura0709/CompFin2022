
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>第13回 機械学習入門4 ニューラルネットワーク &#8212; コンピュテーショナル・ファイナンス</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="第12回 機械学習入門3 決定木" href="12CompFin.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">コンピュテーショナル・ファイナンス</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="この本を検索..." aria-label="この本を検索..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   コンピュテーショナル・ファイナンス
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01CompFin.html">
   第1回 Pythonの基礎1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02CompFin.html">
   第2回 Pyhtonの基礎2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03CompFin.html">
   第3回 NumpyとPandas（金融時系列データ）
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04CompFin.html">
   第4回 関数、行列、最適化
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05CompFin.html">
   第5回 確率過程と確率微分方程式
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06CompFin.html">
   第6回 ツリーモデル1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07CompFin.html">
   第7回 ツリーモデル2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08CompFin.html">
   第8回 モンテカルロ法1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09CompFin.html">
   第9回 モンテカルロ法2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10CompFin.html">
   第10回 機械学習入門1 線形回帰モデル
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11CompFin.html">
   第11回 機械学習入門2 勾配降下法、ロジスティック回帰、クラスタリング
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12CompFin.html">
   第12回 機械学習入門3 決定木
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   第13回 機械学習入門4 ニューラルネットワーク
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="ナビゲーションを切り替え" aria-controls="site-navigation"
                title="ナビゲーションを切り替え" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="このページをダウンロード"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/13CompFin.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="ソースファイルをダウンロード" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="PDFに印刷"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="全画面モード"
        title="全画面モード"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/skamimura0709/CompFin2022/gh-pages?urlpath=tree/_sources/13CompFin.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="発売 Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/skamimura0709/CompFin2022/blob/gh-pages/_sources/13CompFin.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="発売 Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> 目次
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   ニューラルネットワークの基礎
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#keras">
   Kerasによるニューラルネットワークの実装
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#breast-cancer">
     分類（breast_cancerデータ）
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fashion-mnist">
     Fashion MNISTの分類
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#california-housing">
     回帰（California Housing データセット）
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   オプション価格付けへの応用
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id4">
   ノーフリーランチ定理
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>第13回 機械学習入門4 ニューラルネットワーク</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> 目次 </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   ニューラルネットワークの基礎
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#keras">
   Kerasによるニューラルネットワークの実装
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#breast-cancer">
     分類（breast_cancerデータ）
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fashion-mnist">
     Fashion MNISTの分類
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#california-housing">
     回帰（California Housing データセット）
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   オプション価格付けへの応用
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id4">
   ノーフリーランチ定理
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="id1">
<h1>第13回 機械学習入門4 ニューラルネットワーク<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="nn">Input In [1],</span> in <span class="ni">&lt;cell line: 3&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;sklearn&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>ニューラルネットワークの基礎<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://drive.google.com/file/d/1Auq-KliiebZpncycYiReBia9y492jHif/view?usp=sharing">ニューラルネットワークの図</a></p>
<p>入力（特徴量）と出力（正解）の関係を上図のようなネットワーク構造で表現したものを<strong>ニューラルネットワーク</strong>と呼ぶ。
とくに、上図のように入力から出力に向けて一方向に情報が流れるニューラルネットワークを順伝播型ニューラルネットワークと呼ぶ。
また、ニューラルネットワークやそのバリエーション、それらを解くための方法などを総称して深層学習（ディープラーニング）と呼ぶ。
この授業では順伝播型ニューラルネットワークの基本を概観する。</p>
<p><span class="math notranslate nohighlight">\(l\)</span>を層のインデックス、<span class="math notranslate nohighlight">\(L\)</span>を層数として、最初の層（<span class="math notranslate nohighlight">\(l=1\)</span>）を入力層、最後の層（<span class="math notranslate nohighlight">\(l=L\)</span>）を出力層、それ以外を隠れ層と呼ぶ。
層数と各層のユニット数は任意に決めることができる。
第<span class="math notranslate nohighlight">\(l\)</span>層<span class="math notranslate nohighlight">\(i\)</span>番目のユニットへの入力を <span class="math notranslate nohighlight">\(u_i^{(l)}\)</span>，第 <span class="math notranslate nohighlight">\(l\)</span> 層 <span class="math notranslate nohighlight">\(i\)</span> 番目のユニットからの出力を<span class="math notranslate nohighlight">\(z_i^{(l)}\)</span>と表す。
入力層 <span class="math notranslate nohighlight">\(l=1\)</span> においては <span class="math notranslate nohighlight">\(u_i^{(1)}=x_i\)</span> であり、
出力層 <span class="math notranslate nohighlight">\(l=L\)</span> においては <span class="math notranslate nohighlight">\(z_i^{(L)}=y\)</span> である。多値分類問題の場合には出力層のユニット数は3以上になる。
さらに、第 <span class="math notranslate nohighlight">\(l\)</span> 層 <span class="math notranslate nohighlight">\(i\)</span> 番目のユニットから第 <span class="math notranslate nohighlight">\((l+1)\)</span> 層 <span class="math notranslate nohighlight">\(j\)</span> 番目のユニットへの出力の重みを<span class="math notranslate nohighlight">\(w_{ji}^{(l+1)}\)</span>、
バイアスを <span class="math notranslate nohighlight">\(w_{j0}^{(l+1)}\)</span> と書くことにすれば、</p>
<div class="math notranslate nohighlight">
\[ \tag{1}
  u_j^{(l+1)} = w_{j0}^{(l+1)} + \sum_{i}w_{ji}^{(l+1)}z_i^{(l)}
\]</div>
<p>となる。
ここで、<span class="math notranslate nohighlight">\(z_j^{(l+1)}=u_j^{(l+1)}\)</span>としてしまっては、
入力 <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> と出力 <span class="math notranslate nohighlight">\(y\)</span> の関係は線形となってしまい、表現力がまったく改善しない。
ニューラルネットワークでは活性化関数と呼ばれる関数 <span class="math notranslate nohighlight">\(h^{(l)}\)</span> を用いて</p>
<div class="math notranslate nohighlight">
\[ \tag{2}
  z_j^{(l+1)} = h^{(l+1)}\left(u_j^{(l+1)}\right)
\]</div>
<p>とする。
活性化関数としてはシグモイド関数や正規化線形関数 <span class="math notranslate nohighlight">\(h(u)=\max\{0,u\}\)</span> などが用いられる。
また、出力層における活性化関数として、回帰では恒等関数 <span class="math notranslate nohighlight">\(h(u)=u\)</span>を使えばよく、分類ではシグモイド関数（2値分類）やソフトマックス関数（多値分類）を使えばよい。</p>
<p>(1)(2)はまとめて</p>
<div class="math notranslate nohighlight">
\[
  \mathbf{z}^{(l+1)}=h^{(l+1)}(\mathbf{u}^{(l+1)}),\
  \mathbf{u}^{(l+1)}=\mathbf{W}^{(l+1)}\mathbf{z}^{(l)},\quad
  l=1,2,\dots,L-1
\]</div>
<p>と書くことができる。
ここで</p>
<div class="math notranslate nohighlight">
\[\begin{split}
  \mathbf{W}^{(l+1)} = \left(
  \begin{array}{cccc}
    w_{10}^{(l+1)} &amp; w_{11}^{(l+1)} &amp; w_{12}^{(l+1)} &amp; \ldots \\
    w_{20}^{(l+1)} &amp; w_{21}^{(l+1)} &amp; w_{22}^{(l+1)} &amp; \ldots \\
    \vdots &amp; \vdots &amp; \vdots &amp; \ddots
  \end{array} \right),\
  \mathbf{z}^{(l)} = \left(
  \begin{array}{c}
    1 \\ z_1^{(l)} \\ z_2^{(l)} \\ \vdots
  \end{array}
  \right)
\end{split}\]</div>
<p>である。</p>
<p><span class="math notranslate nohighlight">\(\mathbf{W}^{(l+1)}\)</span>
は <span class="math notranslate nohighlight">\((第 (l+1) 層のユニット数) \times (第 l 層のユニット数 + 1)\)</span>行列、
<span class="math notranslate nohighlight">\(\mathbf{z}^{(l)}\)</span>は
<span class="math notranslate nohighlight">\((第 l 層のユニット数 + 1)\)</span>次元ベクトルである。
また、活性化関数 <span class="math notranslate nohighlight">\(h^{(l)}\)</span> の引数がベクトル <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> のときは
<span class="math notranslate nohighlight">\(h^{(l)}(\mathbf{u})=(h^{(l)}(u_1),h^{(l)}(u_2),…)^T\)</span>と定義する。
この表記を使うと、入力 <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> と出力 <span class="math notranslate nohighlight">\(y\)</span> の関係は</p>
<div class="math notranslate nohighlight">
\[ \tag{3}
  y = 
  h^{(L)}\left(\mathbf{W}^{(L)}h^{(L-1)}\left(\cdots h^{(3)}\left(\mathbf{W}^{(3)}h^{(2)}\left(\mathbf{W}^{(2)}\mathbf{x}
  \right)\right)\right)\right)
\]</div>
<p>と書ける。
すなわち、入力 <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> からスタートして線形変換 <span class="math notranslate nohighlight">\(\mathbf{W}^{(l)}\)</span>
と活性化関数 <span class="math notranslate nohighlight">\(h^{(l)}\)</span> による変換をつぎつぎと作用させて、出力 <span class="math notranslate nohighlight">\(y\)</span> に至る。
よって、かなり複雑ではあるが、入力 <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> と出力 <span class="math notranslate nohighlight">\(y\)</span> の間の関係をパラメータ <span class="math notranslate nohighlight">\(\mathbf{w}\)</span> をもつ関数 <span class="math notranslate nohighlight">\(f\)</span> を用いて
<span class="math notranslate nohighlight">\(y=f(\mathbf{x};\mathbf{w})\)</span>
と表現するという機械学習の基本的な考え方は保たれている。</p>
<p>表現力の高い非線形関数 (3) よってモデル化をすることにより、
線形関数では分類できない問題も解ける可能性が出てくる。
あとは、解きたい問題に応じて損失関数</p>
<div class="math notranslate nohighlight">
\[
  L(\mathbf{w})= \frac{1}{N}\sum_{i=1}^N l(\mathbf{x}_i, y_i; \mathbf{w})
\]</div>
<p>を定義して、最小化問題 <span class="math notranslate nohighlight">\(\min_{\mathbf{w}}L(\mathbf{w})\)</span>
を確率的勾配降下法などによって解けばよい。
しかし、ニューラルネットワークにはいくつかの困難がある。</p>
<p>まず、（確率的）勾配降下法には勾配 <span class="math notranslate nohighlight">\(\nabla L(\mathbf{w})\)</span> の計算が必要になるが、<span class="math notranslate nohighlight">\(\nabla L(\mathbf{w})\)</span> の計算には (3) によって定義される <span class="math notranslate nohighlight">\(y\)</span> のパラメータ <span class="math notranslate nohighlight">\(w_{ji}\)</span> に関する偏微分
<span class="math notranslate nohighlight">\(\partial y/\partial w_{ji}\)</span>の計算が必要になる。
単純に数値微分を適用すると、合成関数の微分を何度も繰り返すことになるため、
計算量が莫大になり実用的ではない。
しかし、<strong>誤差逆伝播法</strong>と呼ばれる微分計算がこの問題を解決する。
ニューラルネットワークを含む深層学習が実用化されるようになった理論的背景の一つは誤差逆伝播法の発明とその改良にある。</p>
<p>つぎに、ニューラルネットワークにおける損失関数 <span class="math notranslate nohighlight">\(L(\mathbf{w})\)</span> は一般には凸関数にはならないという問題がある。
したがって、確率的勾配降下法を使って <span class="math notranslate nohighlight">\(\nabla L(\mathbf{w})=0\)</span> の解を求めたとしても、それが大域的最適解になっている保障はない。</p>
<p>また、ニューラルネットワークでは多くのパラメータを持つ非線形関数により入力 <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> と出力 <span class="math notranslate nohighlight">\(y\)</span> の関係をモデル化することから、過学習が起こりやすことが容易に想像できる。
したがって、深層学習においては正則化の技術が一層重要となる。</p>
<p>層数や各層のユニット数をいくつにすればよいのかについても一般論は知られていない。数学的には<strong>普遍近似定理</strong>（Cybenko(1989)など）により、隠れ層が1つ（<span class="math notranslate nohighlight">\(L=2\)</span>）のニューラルネットワークは、隠れ層のユニット数を増やすことにより、任意の連続関数を近似できること、が知られている。しかし、実際には隠れ層のユニット数を増やすよりも、隠れ層の数を増やしたほうが精度が良い場合が多いようだ。</p>
<ul class="simple">
<li><p>Cybenko, G. (1989): Approximations by Superpositions of a Sigmoidal Function,. Vol. 2. Mathematics of Control, Signals, and Systems.</p></li>
</ul>
<p>このようにさまざまな問題があるにも関わらず、
ニューラルネットワークを含め深層学習が画像認識をはじめさまざまな問題に対して高いパフォーマンスを発揮している。
しかし、なぜ深層学習がそこまでうまく機能するのかについては、理論的にはまだ分かっていないことが多い。</p>
</div>
<div class="section" id="keras">
<h2>Kerasによるニューラルネットワークの実装<a class="headerlink" href="#keras" title="Permalink to this headline">¶</a></h2>
<p>Kerasライブラリ <a class="reference external" href="https://keras.io/">https://keras.io/</a> を用いてニューラルネットワークを実装してみる。scikit-learnライブラリにもニューラルネットワークを実装するためのクラスが用意されているが（MLPClassifier, MLPRegressorなど）、柔軟なモデリングはできない。</p>
<div class="section" id="breast-cancer">
<h3>分類（breast_cancerデータ）<a class="headerlink" href="#breast-cancer" title="Permalink to this headline">¶</a></h3>
<p>Breast Cancerデータ(<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.load_breast_cancer.html">https://scikit-learn.org/stable/modules/generated/sklearn.datasets.load_breast_cancer.html</a>) の予測については勾配ブースティング木などで十分な精度は出るが、Kerasの使い方を学ぶため、ニューラルネットワークを用いて分類を行う。</p>
<p>Kerasライブラリのインポート</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
</pre></div>
</div>
</div>
</div>
<p>scikit-learnからデータをロードする。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_breast_cancer</span>
<span class="n">bc</span> <span class="o">=</span> <span class="n">load_breast_cancer</span><span class="p">(</span><span class="n">as_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>特徴量と正解の定義</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Xbc</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">data</span>
<span class="n">ybc</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Xbc</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(569, 30)
</pre></div>
</div>
</div>
</div>
<p>特徴量は30個ある。</p>
<p>訓練データ、検証データ、テストデータに分ける。検証データはハイパーパラメータの決定に使うデータ。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Xbc_train_full</span><span class="p">,</span> <span class="n">Xbc_test</span><span class="p">,</span> <span class="n">ybc_train_full</span><span class="p">,</span> <span class="n">ybc_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">Xbc</span><span class="p">,</span> <span class="n">ybc</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Xbc_train</span><span class="p">,</span> <span class="n">Xbc_valid</span><span class="p">,</span> <span class="n">ybc_train</span><span class="p">,</span> <span class="n">ybc_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">Xbc_train_full</span><span class="p">,</span> <span class="n">ybc_train_full</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>特徴量のスケーリング</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xbc_train</span><span class="p">)</span>
<span class="n">Xbc_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xbc_train</span><span class="p">)</span>
<span class="n">Xbc_valid_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xbc_valid</span><span class="p">)</span>
<span class="n">Xbc_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xbc_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>ニューラルネットワークの作成。入力の数は30、出力は1つ。
ここでは隠れ層を1つ作成し、隠れ層のユニット数を100とする。
隠れ層の活性化関数は<code class="docutils literal notranslate"><span class="pre">relu</span></code>とする。出力層の活性化関数は2値分類なので<code class="docutils literal notranslate"><span class="pre">sigmoid</span></code>とする。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>モデルのサマリーをみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_1&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense_3 (Dense)             (None, 100)               3100      
                                                                 
 dense_4 (Dense)             (None, 100)               10100     
                                                                 
 dense_5 (Dense)             (None, 1)                 101       
                                                                 
=================================================================
Total params: 13,301
Trainable params: 13,301
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<p>モデルのコンパイル。損失関数はバイナリクロスエントロピー（尤度関数の <span class="math notranslate nohighlight">\(-log\)</span> をとったもの、第10回講義を参照）。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>モデルの学習と評価</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xbc_train_scaled</span><span class="p">,</span> <span class="n">ybc_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">Xbc_valid_scaled</span><span class="p">,</span> <span class="n">ybc_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
10/10 [==============================] - 1s 38ms/step - loss: 0.3705 - accuracy: 0.8746 - val_loss: 0.1762 - val_accuracy: 0.9813
Epoch 2/20
10/10 [==============================] - 0s 11ms/step - loss: 0.1757 - accuracy: 0.9530 - val_loss: 0.1103 - val_accuracy: 0.9813
Epoch 3/20
10/10 [==============================] - 0s 10ms/step - loss: 0.1177 - accuracy: 0.9749 - val_loss: 0.0811 - val_accuracy: 0.9720
Epoch 4/20
10/10 [==============================] - 0s 8ms/step - loss: 0.0893 - accuracy: 0.9781 - val_loss: 0.0720 - val_accuracy: 0.9720
Epoch 5/20
10/10 [==============================] - 0s 12ms/step - loss: 0.0711 - accuracy: 0.9781 - val_loss: 0.0661 - val_accuracy: 0.9720
Epoch 6/20
10/10 [==============================] - 0s 10ms/step - loss: 0.0589 - accuracy: 0.9843 - val_loss: 0.0618 - val_accuracy: 0.9626
Epoch 7/20
10/10 [==============================] - 0s 10ms/step - loss: 0.0493 - accuracy: 0.9875 - val_loss: 0.0637 - val_accuracy: 0.9720
Epoch 8/20
10/10 [==============================] - 0s 11ms/step - loss: 0.0434 - accuracy: 0.9875 - val_loss: 0.0643 - val_accuracy: 0.9720
Epoch 9/20
10/10 [==============================] - 0s 8ms/step - loss: 0.0369 - accuracy: 0.9906 - val_loss: 0.0630 - val_accuracy: 0.9720
Epoch 10/20
10/10 [==============================] - 0s 8ms/step - loss: 0.0298 - accuracy: 0.9906 - val_loss: 0.0738 - val_accuracy: 0.9720
Epoch 11/20
10/10 [==============================] - 0s 8ms/step - loss: 0.0254 - accuracy: 0.9906 - val_loss: 0.0747 - val_accuracy: 0.9720
Epoch 12/20
10/10 [==============================] - 0s 15ms/step - loss: 0.0225 - accuracy: 0.9969 - val_loss: 0.0852 - val_accuracy: 0.9626
Epoch 13/20
10/10 [==============================] - 0s 9ms/step - loss: 0.0173 - accuracy: 0.9969 - val_loss: 0.0769 - val_accuracy: 0.9720
Epoch 14/20
10/10 [==============================] - 0s 9ms/step - loss: 0.0154 - accuracy: 0.9969 - val_loss: 0.0841 - val_accuracy: 0.9720
Epoch 15/20
10/10 [==============================] - 0s 9ms/step - loss: 0.0115 - accuracy: 0.9969 - val_loss: 0.0884 - val_accuracy: 0.9626
Epoch 16/20
10/10 [==============================] - 0s 11ms/step - loss: 0.0092 - accuracy: 0.9969 - val_loss: 0.0959 - val_accuracy: 0.9813
Epoch 17/20
10/10 [==============================] - 0s 10ms/step - loss: 0.0075 - accuracy: 0.9969 - val_loss: 0.1041 - val_accuracy: 0.9626
Epoch 18/20
10/10 [==============================] - 0s 8ms/step - loss: 0.0057 - accuracy: 1.0000 - val_loss: 0.1053 - val_accuracy: 0.9626
Epoch 19/20
10/10 [==============================] - 0s 11ms/step - loss: 0.0043 - accuracy: 1.0000 - val_loss: 0.0953 - val_accuracy: 0.9626
Epoch 20/20
10/10 [==============================] - 0s 9ms/step - loss: 0.0036 - accuracy: 1.0000 - val_loss: 0.1039 - val_accuracy: 0.9626
</pre></div>
</div>
</div>
</div>
<p>学習曲線を見る。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">history_data</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
<span class="n">history_data</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/13CompFin_27_0.png" src="_images/13CompFin_27_0.png" />
</div>
</div>
<p>モデルの評価</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">Xbc_test_scaled</span><span class="p">,</span> <span class="n">ybc_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5/5 [==============================] - 0s 3ms/step - loss: 0.1211 - accuracy: 0.9650
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.12108062207698822, 0.9650349617004395]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fashion-mnist">
<h3>Fashion MNISTの分類<a class="headerlink" href="#fashion-mnist" title="Permalink to this headline">¶</a></h3>
<p>ニューラルネットワークらしい分類問題としてFashion MINSTデータ（<a class="reference external" href="https://keras.io/api/datasets/fashion_mnist/">https://keras.io/api/datasets/fashion_mnist/</a> ）の分類を行う。</p>
<p>データをロードする。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">Xfm_train_full</span><span class="p">,</span> <span class="n">yfm_train_full</span><span class="p">),</span> <span class="p">(</span><span class="n">Xfm_test</span><span class="p">,</span> <span class="n">yfm_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">fashion_mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-labels-idx1-ubyte.gz
32768/29515 [=================================] - 0s 0us/step
40960/29515 [=========================================] - 0s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-images-idx3-ubyte.gz
26427392/26421880 [==============================] - 0s 0us/step
26435584/26421880 [==============================] - 0s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-labels-idx1-ubyte.gz
16384/5148 [===============================================================================================] - 0s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-images-idx3-ubyte.gz
4423680/4422102 [==============================] - 0s 0us/step
4431872/4422102 [==============================] - 0s 0us/step
</pre></div>
</div>
</div>
</div>
<p>特徴量と正解の次元を見ておく。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">Xfm_train_full</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yfm_train_full</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(60000, 28, 28)
(60000,)
</pre></div>
</div>
</div>
</div>
<p>特徴量である画像データを見てみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Xfm_train_full</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7ff616339690&gt;
</pre></div>
</div>
<img alt="_images/13CompFin_35_1.png" src="_images/13CompFin_35_1.png" />
</div>
</div>
<p>正解は？</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yfm_train_full</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yfm_train_full</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([9, 0, 0, ..., 3, 0, 5], dtype=uint8)
</pre></div>
</div>
</div>
</div>
<p>正解を one-hot 形式に変換する。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yfm_train_full</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">yfm_train_full</span><span class="p">)</span>
<span class="n">yfm_test</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">yfm_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yfm_train_full</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0., 0., 0., ..., 0., 0., 1.],
       [1., 0., 0., ..., 0., 0., 0.],
       [1., 0., 0., ..., 0., 0., 0.],
       ...,
       [0., 0., 0., ..., 0., 0., 0.],
       [1., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.]], dtype=float32)
</pre></div>
</div>
</div>
</div>
<p>訓練データと検証データの作成。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Xfm_train</span><span class="p">,</span> <span class="n">Xfm_valid</span><span class="p">,</span> <span class="n">yfm_train</span><span class="p">,</span> <span class="n">yfm_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">Xfm_train_full</span><span class="p">,</span> <span class="n">yfm_train_full</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>特徴量のスケーリング。特徴量の各成分は0から255の数値で表される明度なので、255で割って、0から1の数値にスケーリングする。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Xfm_train</span> <span class="o">=</span> <span class="n">Xfm_train</span> <span class="o">/</span> <span class="mi">255</span>
<span class="n">Xfm_valid</span> <span class="o">=</span> <span class="n">Xfm_valid</span> <span class="o">/</span> <span class="mi">255</span>
<span class="n">Xfm_test</span> <span class="o">=</span> <span class="n">Xfm_test</span> <span class="o">/</span> <span class="mi">255</span>
</pre></div>
</div>
</div>
</div>
<p>ニューラルネットワークの作成。最初に2次元<span class="math notranslate nohighlight">\((28, 28)\)</span>の特徴量を1次元に変換している（<code class="docutils literal notranslate"><span class="pre">keras.layers.Flatten</span></code>）。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">]))</span>
<span class="n">model1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_2&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 flatten (Flatten)           (None, 784)               0         
                                                                 
 dense_6 (Dense)             (None, 1000)              785000    
                                                                 
 dense_7 (Dense)             (None, 1000)              1001000   
                                                                 
 dense_8 (Dense)             (None, 10)                10010     
                                                                 
=================================================================
Total params: 1,796,010
Trainable params: 1,796,010
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model1</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> 
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history1</span> <span class="o">=</span> <span class="n">model1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xfm_train</span><span class="p">,</span> <span class="n">yfm_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">Xfm_valid</span><span class="p">,</span> <span class="n">yfm_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/30
1407/1407 [==============================] - 21s 14ms/step - loss: 0.5309 - accuracy: 0.8102 - val_loss: 0.5431 - val_accuracy: 0.8221
Epoch 2/30
1407/1407 [==============================] - 21s 15ms/step - loss: 0.4232 - accuracy: 0.8522 - val_loss: 0.4080 - val_accuracy: 0.8609
Epoch 3/30
1407/1407 [==============================] - 22s 16ms/step - loss: 0.3945 - accuracy: 0.8635 - val_loss: 0.4624 - val_accuracy: 0.8568
Epoch 4/30
1407/1407 [==============================] - 21s 15ms/step - loss: 0.3794 - accuracy: 0.8703 - val_loss: 0.4005 - val_accuracy: 0.8709
Epoch 5/30
1407/1407 [==============================] - 22s 16ms/step - loss: 0.3677 - accuracy: 0.8770 - val_loss: 0.3983 - val_accuracy: 0.8825
Epoch 6/30
1407/1407 [==============================] - 20s 15ms/step - loss: 0.3537 - accuracy: 0.8800 - val_loss: 0.4306 - val_accuracy: 0.8751
Epoch 7/30
1407/1407 [==============================] - 21s 15ms/step - loss: 0.3455 - accuracy: 0.8853 - val_loss: 0.4708 - val_accuracy: 0.8760
Epoch 8/30
1407/1407 [==============================] - 20s 14ms/step - loss: 0.3413 - accuracy: 0.8860 - val_loss: 0.4802 - val_accuracy: 0.8771
Epoch 9/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.3334 - accuracy: 0.8886 - val_loss: 0.4363 - val_accuracy: 0.8751
Epoch 10/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.3252 - accuracy: 0.8925 - val_loss: 0.4755 - val_accuracy: 0.8749
Epoch 11/30
1407/1407 [==============================] - 20s 14ms/step - loss: 0.3254 - accuracy: 0.8934 - val_loss: 0.4619 - val_accuracy: 0.8759
Epoch 12/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.3144 - accuracy: 0.8961 - val_loss: 0.4913 - val_accuracy: 0.8755
Epoch 13/30
1407/1407 [==============================] - 20s 14ms/step - loss: 0.3103 - accuracy: 0.8978 - val_loss: 0.5710 - val_accuracy: 0.8724
Epoch 14/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.3052 - accuracy: 0.9002 - val_loss: 0.4708 - val_accuracy: 0.8841
Epoch 15/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.3017 - accuracy: 0.9011 - val_loss: 0.5350 - val_accuracy: 0.8823
Epoch 16/30
1407/1407 [==============================] - 20s 14ms/step - loss: 0.2960 - accuracy: 0.9040 - val_loss: 0.6226 - val_accuracy: 0.8601
Epoch 17/30
1407/1407 [==============================] - 19s 13ms/step - loss: 0.3008 - accuracy: 0.9034 - val_loss: 0.5479 - val_accuracy: 0.8829
Epoch 18/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.2937 - accuracy: 0.9056 - val_loss: 0.6108 - val_accuracy: 0.8872
Epoch 19/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.2978 - accuracy: 0.9063 - val_loss: 0.6486 - val_accuracy: 0.8739
Epoch 20/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.2907 - accuracy: 0.9081 - val_loss: 0.7432 - val_accuracy: 0.8487
Epoch 21/30
1407/1407 [==============================] - 21s 15ms/step - loss: 0.2879 - accuracy: 0.9093 - val_loss: 0.6690 - val_accuracy: 0.8776
Epoch 22/30
1407/1407 [==============================] - 20s 15ms/step - loss: 0.2794 - accuracy: 0.9103 - val_loss: 0.7252 - val_accuracy: 0.8798
Epoch 23/30
1407/1407 [==============================] - 17s 12ms/step - loss: 0.2818 - accuracy: 0.9109 - val_loss: 0.8015 - val_accuracy: 0.8826
Epoch 24/30
1407/1407 [==============================] - 17s 12ms/step - loss: 0.2793 - accuracy: 0.9132 - val_loss: 0.6849 - val_accuracy: 0.8749
Epoch 25/30
1407/1407 [==============================] - 17s 12ms/step - loss: 0.2742 - accuracy: 0.9153 - val_loss: 0.6986 - val_accuracy: 0.8846
Epoch 26/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.2777 - accuracy: 0.9149 - val_loss: 0.6322 - val_accuracy: 0.8860
Epoch 27/30
1407/1407 [==============================] - 17s 12ms/step - loss: 0.2684 - accuracy: 0.9152 - val_loss: 0.6742 - val_accuracy: 0.8865
Epoch 28/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.2717 - accuracy: 0.9173 - val_loss: 0.9084 - val_accuracy: 0.8631
Epoch 29/30
1407/1407 [==============================] - 17s 12ms/step - loss: 0.2731 - accuracy: 0.9161 - val_loss: 0.7500 - val_accuracy: 0.8790
Epoch 30/30
1407/1407 [==============================] - 18s 13ms/step - loss: 0.2586 - accuracy: 0.9177 - val_loss: 0.6585 - val_accuracy: 0.8875
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history1_data</span> <span class="o">=</span> <span class="n">history1</span><span class="o">.</span><span class="n">history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history1_data</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history1_data</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/13CompFin_51_0.png" src="_images/13CompFin_51_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">Xfm_test</span><span class="p">,</span> <span class="n">yfm_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>313/313 [==============================] - 1s 4ms/step - loss: 0.7899 - accuracy: 0.8794
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.7899182438850403, 0.8794000148773193]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="california-housing">
<h3>回帰（California Housing データセット）<a class="headerlink" href="#california-housing" title="Permalink to this headline">¶</a></h3>
<p>ニューラルネットワークは回帰問題を扱うこともできる。モデルのコンパイルをする際に損失関数（<code class="docutils literal notranslate"><span class="pre">loss</span></code>オプション）を回帰向けのものにすればよいだけである。California Housing データセットを用いて住宅価格の予測を行う。</p>
<p>データをロードする。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_california_housing</span>
<span class="n">cal</span> <span class="o">=</span> <span class="n">fetch_california_housing</span><span class="p">()</span>
<span class="n">Xcal</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">data</span>
<span class="n">ycal</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">DESCR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>.. _california_housing_dataset:

California Housing dataset
--------------------------

**Data Set Characteristics:**

    :Number of Instances: 20640

    :Number of Attributes: 8 numeric, predictive attributes and the target

    :Attribute Information:
        - MedInc        median income in block group
        - HouseAge      median house age in block group
        - AveRooms      average number of rooms per household
        - AveBedrms     average number of bedrooms per household
        - Population    block group population
        - AveOccup      average number of household members
        - Latitude      block group latitude
        - Longitude     block group longitude

    :Missing Attribute Values: None

This dataset was obtained from the StatLib repository.
https://www.dcc.fc.up.pt/~ltorgo/Regression/cal_housing.html

The target variable is the median house value for California districts,
expressed in hundreds of thousands of dollars ($100,000).

This dataset was derived from the 1990 U.S. census, using one row per census
block group. A block group is the smallest geographical unit for which the U.S.
Census Bureau publishes sample data (a block group typically has a population
of 600 to 3,000 people).

An household is a group of people residing within a home. Since the average
number of rooms and bedrooms in this dataset are provided per household, these
columns may take surpinsingly large values for block groups with few households
and many empty houses, such as vacation resorts.

It can be downloaded/loaded using the
:func:`sklearn.datasets.fetch_california_housing` function.

.. topic:: References

    - Pace, R. Kelley and Ronald Barry, Sparse Spatial Autoregressions,
      Statistics and Probability Letters, 33 (1997) 291-297
</pre></div>
</div>
</div>
</div>
<p>訓練データ、検証データ、テストデータに分ける。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Xcal_train_full</span><span class="p">,</span> <span class="n">Xcal_test</span><span class="p">,</span> <span class="n">ycal_train_full</span><span class="p">,</span> <span class="n">ycal_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">Xcal</span><span class="p">,</span> <span class="n">ycal</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Xcal_train</span><span class="p">,</span> <span class="n">Xcal_valid</span><span class="p">,</span> <span class="n">ycal_train</span><span class="p">,</span> <span class="n">ycal_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">Xcal_train_full</span><span class="p">,</span> <span class="n">ycal_train_full</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>特徴量のスケーリング。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler2</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xcal_train</span><span class="p">)</span>
<span class="n">Xcal_train_scaled</span> <span class="o">=</span> <span class="n">scaler2</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xcal_train</span><span class="p">)</span>
<span class="n">Xcal_test_scaled</span> <span class="o">=</span> <span class="n">scaler2</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xcal_test</span><span class="p">)</span>
<span class="n">Xcal_valid_scaled</span> <span class="o">=</span> <span class="n">scaler2</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xcal_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>モデルの構築。回帰問題なので出力層の活性化関数は恒等関数（<code class="docutils literal notranslate"><span class="pre">linear</span></code> または何も指定しなくてよい）。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,)))</span>
<span class="n">model2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>モデルのコンパイル。損失関数には平均二乗誤差を使う。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history2</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xcal_train_scaled</span><span class="p">,</span> <span class="n">ycal_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">Xcal_valid_scaled</span><span class="p">,</span> <span class="n">ycal_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/30
363/363 [==============================] - 2s 3ms/step - loss: 0.6591 - val_loss: 0.4013
Epoch 2/30
363/363 [==============================] - 1s 2ms/step - loss: 0.4082 - val_loss: 0.3609
Epoch 3/30
363/363 [==============================] - 1s 3ms/step - loss: 0.3872 - val_loss: 0.3564
Epoch 4/30
363/363 [==============================] - 1s 2ms/step - loss: 0.3685 - val_loss: 0.3448
Epoch 5/30
363/363 [==============================] - 1s 3ms/step - loss: 0.3572 - val_loss: 0.3286
Epoch 6/30
363/363 [==============================] - 1s 2ms/step - loss: 0.3465 - val_loss: 0.3379
Epoch 7/30
363/363 [==============================] - 1s 2ms/step - loss: 0.3541 - val_loss: 0.3264
Epoch 8/30
363/363 [==============================] - 1s 3ms/step - loss: 0.3194 - val_loss: 0.3136
Epoch 9/30
363/363 [==============================] - 1s 3ms/step - loss: 0.3494 - val_loss: 0.3055
Epoch 10/30
363/363 [==============================] - 1s 2ms/step - loss: 0.3045 - val_loss: 0.3315
Epoch 11/30
363/363 [==============================] - 1s 2ms/step - loss: 0.3102 - val_loss: 0.3018
Epoch 12/30
363/363 [==============================] - 1s 2ms/step - loss: 0.3159 - val_loss: 0.3185
Epoch 13/30
363/363 [==============================] - 1s 2ms/step - loss: 0.3515 - val_loss: 0.3155
Epoch 14/30
363/363 [==============================] - 1s 2ms/step - loss: 0.3243 - val_loss: 0.2849
Epoch 15/30
363/363 [==============================] - 1s 2ms/step - loss: 0.2892 - val_loss: 0.3045
Epoch 16/30
363/363 [==============================] - 1s 3ms/step - loss: 0.2956 - val_loss: 0.3220
Epoch 17/30
363/363 [==============================] - 1s 3ms/step - loss: 0.2807 - val_loss: 0.3052
Epoch 18/30
363/363 [==============================] - 1s 3ms/step - loss: 0.3010 - val_loss: 0.3070
Epoch 19/30
363/363 [==============================] - 1s 2ms/step - loss: 0.2836 - val_loss: 0.3413
Epoch 20/30
363/363 [==============================] - 1s 2ms/step - loss: 0.2840 - val_loss: 0.3045
Epoch 21/30
363/363 [==============================] - 1s 2ms/step - loss: 0.2750 - val_loss: 0.3033
Epoch 22/30
363/363 [==============================] - 1s 3ms/step - loss: 0.3068 - val_loss: 0.2978
Epoch 23/30
363/363 [==============================] - 1s 2ms/step - loss: 0.2694 - val_loss: 0.2875
Epoch 24/30
363/363 [==============================] - 1s 2ms/step - loss: 0.2748 - val_loss: 0.2831
Epoch 25/30
363/363 [==============================] - 1s 2ms/step - loss: 0.3433 - val_loss: 0.2895
Epoch 26/30
363/363 [==============================] - 1s 3ms/step - loss: 0.2708 - val_loss: 0.3040
Epoch 27/30
363/363 [==============================] - 2s 4ms/step - loss: 0.2778 - val_loss: 0.2839
Epoch 28/30
363/363 [==============================] - 2s 5ms/step - loss: 0.2730 - val_loss: 0.2972
Epoch 29/30
363/363 [==============================] - 1s 4ms/step - loss: 0.2631 - val_loss: 0.2889
Epoch 30/30
363/363 [==============================] - 1s 3ms/step - loss: 0.2700 - val_loss: 0.2787
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history2_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history2</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">history2_data</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">)</span>
<span class="n">history2_data</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;val_mse&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/13CompFin_65_0.png" src="_images/13CompFin_65_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h2>オプション価格付けへの応用<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>ニューラルネットワークをオプション価格付けに応用する試みは以下の論文など古くから試みられている。</p>
<ul class="simple">
<li><p>J. M. Hutchinson, A. W. Lo, and T. Poggio. A nonparametric approach to pricing and hedging
derivative securities via learning networks. Journal of Finance, 49(3):851–889, 1994.</p></li>
</ul>
<p>最近の研究については以下の文献などを参照。</p>
<ul class="simple">
<li><p>J. Hull. “Machine Learning in Business: An Introduction to the World of Data Science”. Amazon Fulfillment Poland Sp. 2021</p></li>
<li><p>J. Ruf and W. Wang. “Neural networks for option pricing and hedging: a literature review”. Journal of Computational Finance, 21(1):1–46, 2020.</p></li>
<li><p>Buehler, H., L. Gonon, J. Teichmann, and B. Wood. “Deep hedging”, Quantitative Finance, 19, 1271–91. 2019.</p></li>
</ul>
<p>機械学習のファイナンスへの応用は以下の文献など。</p>
<ul class="simple">
<li><p>M. López de Prado.
“Advances in Financial Machine Learning”.,
John Wiley &amp; Sons, 2018.
（日本語訳: 長尾慎太郎, 鹿子木亨紀（監訳）. 「ファイナンス機械学習―金融市場分析を変える機械学習アルゴリズムの理論と実践」, きんざい, 2019.）</p></li>
<li><p>参考書（Pythonによるファイナンス）第15, 16章</p></li>
</ul>
<p>Black-Scholes公式によればヨーロピアンコールオプションに対する価格<span class="math notranslate nohighlight">\(C\)</span>は以下で与えられる。</p>
<p>\begin{align}
C &amp;= SN(d_1) - Ke^{-rT}N(d_2)\
d_1 &amp;= \frac{\ln(S/K) + (r + \sigma^2/2)T}{\sigma\sqrt{T}}\
d_2 &amp;= d_1 - \sigma\sqrt{T}
\end{align}</p>
<p>BS公式が前提とする仮定の元ではオプション価格は<span class="math notranslate nohighlight">\(S\)</span>, <span class="math notranslate nohighlight">\(K\)</span>, <span class="math notranslate nohighlight">\(T\)</span>, <span class="math notranslate nohighlight">\(r\)</span>, <span class="math notranslate nohighlight">\(\sigma\)</span>の関数で与えられる。
BS公式のように価格が市場パラメータの陽関数で与えられる場合もあれば、
仮定するモデルによっては
モンテカルロシミュレーションにより価格を求めざるを得ない場合もある。
いずれにせよ、オプション価格を求めるということは、さまざまなパラメータとオプション価格の関係を（それが陽関数で表現できるかどうかは別として）求めることに他ならない。そうすると、オプション価格付け問題を、オプション価格を正解、その他の市場データやオプション契約のパラメータを特徴量とした教師あり学習とみなすことができるだろう。</p>
<p>ここではオプションの市場データをニューラルネットワークにより学習させることを試みる。</p>
<p>データ <code class="docutils literal notranslate"><span class="pre">call2018.csv</span></code> を読み込む。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">call_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">call_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-884499b2-06fb-45ba-b761-1a13a40c3227">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Trade_Date</th>
      <th>Close_Price</th>
      <th>Trade_Volume</th>
      <th>TTM</th>
      <th>Exercise_Price</th>
      <th>Spot</th>
      <th>vol</th>
      <th>rf</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>20180104</td>
      <td>2350</td>
      <td>4</td>
      <td>0.021918</td>
      <td>21000</td>
      <td>23506.33</td>
      <td>0.12682</td>
      <td>-0.00047</td>
    </tr>
    <tr>
      <th>1</th>
      <td>20180104</td>
      <td>1850</td>
      <td>4</td>
      <td>0.021918</td>
      <td>21500</td>
      <td>23506.33</td>
      <td>0.12682</td>
      <td>-0.00047</td>
    </tr>
    <tr>
      <th>2</th>
      <td>20180104</td>
      <td>1510</td>
      <td>4</td>
      <td>0.021918</td>
      <td>21875</td>
      <td>23506.33</td>
      <td>0.12682</td>
      <td>-0.00047</td>
    </tr>
    <tr>
      <th>3</th>
      <td>20180104</td>
      <td>1470</td>
      <td>10</td>
      <td>0.021918</td>
      <td>22000</td>
      <td>23506.33</td>
      <td>0.12682</td>
      <td>-0.00047</td>
    </tr>
    <tr>
      <th>4</th>
      <td>20180104</td>
      <td>580</td>
      <td>5</td>
      <td>0.021918</td>
      <td>22250</td>
      <td>23506.33</td>
      <td>0.12682</td>
      <td>-0.00047</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-884499b2-06fb-45ba-b761-1a13a40c3227')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>

  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-884499b2-06fb-45ba-b761-1a13a40c3227 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-884499b2-06fb-45ba-b761-1a13a40c3227');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
</div></div>
</div>
<p>正解と特徴量を生成。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Xop_df</span> <span class="o">=</span> <span class="n">call_df</span><span class="p">[[</span><span class="s1">&#39;Spot&#39;</span><span class="p">,</span> <span class="s1">&#39;Exercise_Price&#39;</span><span class="p">,</span> <span class="s1">&#39;TTM&#39;</span><span class="p">,</span> <span class="s1">&#39;rf&#39;</span><span class="p">,</span> <span class="s1">&#39;vol&#39;</span><span class="p">]]</span>
<span class="n">yop_df</span> <span class="o">=</span> <span class="n">call_df</span><span class="p">[</span><span class="s1">&#39;Close_Price&#39;</span><span class="p">]</span>
<span class="n">Xop_np</span> <span class="o">=</span> <span class="n">Xop_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">yop_np</span> <span class="o">=</span> <span class="n">yop_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Xop_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-435915cd-c520-4b49-9f4d-dd06343410f9">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Spot</th>
      <th>Exercise_Price</th>
      <th>TTM</th>
      <th>rf</th>
      <th>vol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>23506.33</td>
      <td>21000</td>
      <td>0.021918</td>
      <td>-0.00047</td>
      <td>0.12682</td>
    </tr>
    <tr>
      <th>1</th>
      <td>23506.33</td>
      <td>21500</td>
      <td>0.021918</td>
      <td>-0.00047</td>
      <td>0.12682</td>
    </tr>
    <tr>
      <th>2</th>
      <td>23506.33</td>
      <td>21875</td>
      <td>0.021918</td>
      <td>-0.00047</td>
      <td>0.12682</td>
    </tr>
    <tr>
      <th>3</th>
      <td>23506.33</td>
      <td>22000</td>
      <td>0.021918</td>
      <td>-0.00047</td>
      <td>0.12682</td>
    </tr>
    <tr>
      <th>4</th>
      <td>23506.33</td>
      <td>22250</td>
      <td>0.021918</td>
      <td>-0.00047</td>
      <td>0.12682</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-435915cd-c520-4b49-9f4d-dd06343410f9')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>

  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-435915cd-c520-4b49-9f4d-dd06343410f9 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-435915cd-c520-4b49-9f4d-dd06343410f9');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
</div></div>
</div>
<p>訓練データ、検証データ、テストデータに分ける。<code class="docutils literal notranslate"><span class="pre">train_test_split</span></code>は使わない。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1〜16852を訓練データ、16853〜21028を検証データ、21029以降をテストデータ</span>
<span class="c1"># valid_index = 16853</span>
<span class="n">Xop_train</span> <span class="o">=</span> <span class="n">Xop_np</span><span class="p">[:</span><span class="mi">16853</span><span class="p">,:]</span>
<span class="n">Xop_valid</span> <span class="o">=</span> <span class="n">Xop_np</span><span class="p">[</span><span class="mi">16853</span><span class="p">:</span><span class="mi">21029</span><span class="p">,:]</span>
<span class="n">Xop_test</span> <span class="o">=</span> <span class="n">Xop_np</span><span class="p">[</span><span class="mi">21029</span><span class="p">:,:]</span>

<span class="n">yop_train</span> <span class="o">=</span> <span class="n">yop_np</span><span class="p">[:</span><span class="mi">16853</span><span class="p">]</span>
<span class="n">yop_valid</span> <span class="o">=</span> <span class="n">yop_np</span><span class="p">[</span><span class="mi">16853</span><span class="p">:</span><span class="mi">21029</span><span class="p">]</span>
<span class="n">yop_test</span> <span class="o">=</span> <span class="n">yop_np</span><span class="p">[</span><span class="mi">21029</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>特徴量のスケーリング</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler3</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xop_train</span><span class="p">)</span>
<span class="n">Xop_train_scaled</span> <span class="o">=</span> <span class="n">scaler3</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xop_train</span><span class="p">)</span>
<span class="n">Xop_valid_scaled</span> <span class="o">=</span> <span class="n">scaler3</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xop_valid</span><span class="p">)</span>
<span class="n">Xop_test_scaled</span> <span class="o">=</span> <span class="n">scaler3</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xop_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model3</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">Xop_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
<span class="n">model3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model3</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">)</span>
<span class="n">history3</span> <span class="o">=</span> <span class="n">model3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xop_train_scaled</span><span class="p">,</span> <span class="n">yop_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">Xop_valid_scaled</span><span class="p">,</span> <span class="n">yop_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/30
527/527 [==============================] - 2s 2ms/step - loss: 305014.2812 - val_loss: 141224.4062
Epoch 2/30
527/527 [==============================] - 1s 2ms/step - loss: 133944.6562 - val_loss: 54574.0352
Epoch 3/30
527/527 [==============================] - 1s 2ms/step - loss: 58727.7266 - val_loss: 25327.7012
Epoch 4/30
527/527 [==============================] - 1s 2ms/step - loss: 27438.5371 - val_loss: 13440.3740
Epoch 5/30
527/527 [==============================] - 1s 2ms/step - loss: 13415.7061 - val_loss: 9360.9033
Epoch 6/30
527/527 [==============================] - 1s 2ms/step - loss: 7543.5693 - val_loss: 8070.0957
Epoch 7/30
527/527 [==============================] - 1s 2ms/step - loss: 5217.7715 - val_loss: 6844.0283
Epoch 8/30
527/527 [==============================] - 1s 2ms/step - loss: 4059.5000 - val_loss: 6423.1079
Epoch 9/30
527/527 [==============================] - 1s 2ms/step - loss: 3626.9592 - val_loss: 6406.7422
Epoch 10/30
527/527 [==============================] - 1s 2ms/step - loss: 3334.5227 - val_loss: 5540.5972
Epoch 11/30
527/527 [==============================] - 1s 2ms/step - loss: 3272.8926 - val_loss: 5733.0479
Epoch 12/30
527/527 [==============================] - 2s 3ms/step - loss: 3025.7732 - val_loss: 5731.6172
Epoch 13/30
527/527 [==============================] - 1s 2ms/step - loss: 2974.5488 - val_loss: 5749.4004
Epoch 14/30
527/527 [==============================] - 1s 2ms/step - loss: 2889.9868 - val_loss: 6155.9663
Epoch 15/30
527/527 [==============================] - 1s 2ms/step - loss: 2733.6208 - val_loss: 6206.9170
Epoch 16/30
527/527 [==============================] - 1s 2ms/step - loss: 2657.6367 - val_loss: 5678.2188
Epoch 17/30
527/527 [==============================] - 1s 2ms/step - loss: 2577.9578 - val_loss: 5420.0952
Epoch 18/30
527/527 [==============================] - 1s 2ms/step - loss: 2544.4468 - val_loss: 5403.9595
Epoch 19/30
527/527 [==============================] - 1s 2ms/step - loss: 2464.7166 - val_loss: 5042.4883
Epoch 20/30
527/527 [==============================] - 1s 2ms/step - loss: 2401.5457 - val_loss: 5234.3901
Epoch 21/30
527/527 [==============================] - 1s 2ms/step - loss: 2349.8167 - val_loss: 5364.1616
Epoch 22/30
527/527 [==============================] - 1s 2ms/step - loss: 2350.2400 - val_loss: 5200.5967
Epoch 23/30
527/527 [==============================] - 1s 2ms/step - loss: 2289.7224 - val_loss: 4631.8804
Epoch 24/30
527/527 [==============================] - 1s 2ms/step - loss: 2270.3813 - val_loss: 4783.5479
Epoch 25/30
527/527 [==============================] - 1s 2ms/step - loss: 2240.2600 - val_loss: 5267.1499
Epoch 26/30
527/527 [==============================] - 1s 2ms/step - loss: 2240.1301 - val_loss: 4853.1553
Epoch 27/30
527/527 [==============================] - 1s 2ms/step - loss: 2199.2368 - val_loss: 5285.0771
Epoch 28/30
527/527 [==============================] - 1s 2ms/step - loss: 2174.8071 - val_loss: 4787.4478
Epoch 29/30
527/527 [==============================] - 1s 2ms/step - loss: 2132.4478 - val_loss: 5565.4233
Epoch 30/30
527/527 [==============================] - 1s 2ms/step - loss: 2123.8743 - val_loss: 5212.0278
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model3</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">Xop_test_scaled</span><span class="p">,</span> <span class="n">yop_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>163/163 [==============================] - 0s 1ms/step - loss: 3396.0107
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3396.0107421875
</pre></div>
</div>
</div>
</div>
<p>BSモデルによる誤差の計算。まず、BS公式を定義。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">exp</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="k">def</span> <span class="nf">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">sigma</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">S</span><span class="o">/</span><span class="n">K</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">d2</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">sigma</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">sigma</span><span class="p">)</span><span class="o">-</span><span class="n">sigma</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bs_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">sigma</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">S</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">sigma</span><span class="p">))</span><span class="o">-</span><span class="n">K</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">sigma</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">bs_call_value</span><span class="p">(</span><span class="n">X</span><span class="p">):</span> <span class="c1"># X: DataFrame</span>
  <span class="n">datasize</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">call_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">datasize</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">datasize</span><span class="p">):</span>
    <span class="n">call_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bs_call</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">call_value</span>
</pre></div>
</div>
</div>
</div>
<p>平均二乗誤差を計算する。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bs</span> <span class="o">=</span> <span class="n">bs_call_value</span><span class="p">(</span><span class="n">Xop_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">yop_test</span><span class="p">,</span> <span class="n">bs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>35740.772542092855
</pre></div>
</div>
</div>
</div>
<p>この手法を使えば、特徴量をBS公式の入力（<span class="math notranslate nohighlight">\(S, K, T, r, \sigma\)</span>）に限定する必要はなく、他の市場データを特徴量に入れることもできる。</p>
</div>
<div class="section" id="id4">
<h2>ノーフリーランチ定理<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>ここまでいくつかの機械学習のアルゴリズムを紹介してきた。
この授業で紹介したアルゴリズム以外にもさまざまなものが知られており、
同じ問題に対して複数のアルゴリズムが適用できる場合はたくさんある。
では、結局どのアルゴリズムを用いるのが一番よいのだろうか。
Wolpert (1996)やWolpert and Macready (1997)によるノーフリーランチ定理を紹介する。
これらの論文の記述は数学的であるが、簡単に述べれば以下を主張している。</p>
<ul class="simple">
<li><p>データに関して何の前提条件も設けなければ、あらゆる問題について最高のパフォーマンスをもつアルゴリズムは存在しない</p></li>
</ul>
<p>つぎのように言い換えることもできる。</p>
<ul class="simple">
<li><p>アルゴリズムAがある問題について最もよいパフォーマンスをもっていたとしても、
それとは別の問題が存在して、そこでは別のアルゴリズムBがアルゴリズムAよりよいパフォーマンスをもつ</p></li>
</ul>
<p>すなわち、あらゆる問題を効率的に解く万能なアルゴリズムは存在しないということである。したがって、機械学習においてはデータや問題の特性にあわせたアルゴリズムを選択することが重要ということになる。</p>
<ul class="simple">
<li><p>Wolpert, D. H., and W. G. Macready. (1997): “No free lunch theorems for optimization,” IEEE Transactions on Evolutionary Computation, 1, 67–82.</p></li>
<li><p>Wolpert, D. H. (1996): “The Lack of A Priori Distinctions Between Learning Algorithms,” Neural computation, 8, 1341–90.</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="12CompFin.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">第12回 機械学習入門3 決定木</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      著者 上村昌司 (kamimura@reitaku-u.ac.jp)<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>